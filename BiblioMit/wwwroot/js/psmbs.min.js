var __awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},loaderStart=()=>{document.getElementById("preloader-background").style.display="block"},loaderStop=()=>{document.getElementById("preloader-background").style.display="none"},epsmb,ecompany,psmb,opts,noop,passive,filter;loaderStart();var Area=function(n){return(google.maps.geometry.spherical.computeArea(n)/1e4).toFixed(2)},flatten=function(n){const t=[];return n.forEach(n=>{Array.isArray(n)?t.push(...flatten(n)):t.push(n)}),t},getBounds=function(n){var t=new google.maps.LatLngBounds;return flatten(n).forEach(n=>t.extend(n)),t},type=document.getElementById("type").value,isresearch=type==="5",selected="red",lang=$("html").attr("lang"),esp=lang==="es",choiceOps={maxItemCount:50,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,fuseOptions:{include:"score"}};esp&&(choiceOps.searchPlaceholderValue="Buscar",choiceOps.loadingText="Cargando...",choiceOps.noResultsText="Sin resultados",choiceOps.noChoicesText="Sin opciones a elegir",choiceOps.itemSelectText="Presione para seleccionar",choiceOps.maxItemText=n=>`Máximo ${n} valores`);epsmb=document.getElementById("psmb");ecompany=document.getElementById("company");choiceOps.placeholderValue=esp?"Seleccione comunas":"Select communes";psmb=new Choices(epsmb,choiceOps);choiceOps.placeholderValue=esp?"Seleccione compañías/instituciones":"Select companies/institutions";var company=new Choices(ecompany,choiceOps),map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"terrain"}),infowindow=new google.maps.InfoWindow({maxWidth:500}),tableInfo={},polygons={},markers={},companies={},psmbs={},markerCluster,data=document.getElementById("map-holder").dataset,bnds=new google.maps.LatLngBounds,showInfo=function(){var n=this.zIndex,t=polygons[n]!=null?Area(polygons[n].getPath().getArray()):"",i=`<h4>${tableInfo[n].code} ${tableInfo[n].name}</h4>
<table><tr><th>${data.code}</th><td align=""right"">${tableInfo[n].code}</td></tr>
<tr><th>${data.company}</th><td align=""right"">${tableInfo[n].businessName}</td></tr>
<tr><th>RUT</th><td align=""right"">${tableInfo[n].rut}</td></tr>
<tr><th>${data.locality}</th><td align=""right"">${tableInfo[n].name}</td></tr>
<tr><th>${data.commune}</th><td align=""right"">${tableInfo[n].comuna}</td></tr>
<tr><th>${data.province}</th><td align=""right"">${tableInfo[n].provincia}</td></tr>
<tr><th>${data.region}</th><td align=""right"">${tableInfo[n].region}</td></tr></tr>
<tr><th>${data.area}</th><td align=""right"">`,r=`</td></tr><tr><a href=""/Centres/Details/${n}"">${data.details}</a></tr>
<tr><th>${data.sources}</th><td></td></tr><tr><td>Sernapesca</td>
<td align=""right""><a target=""_blank"" href=""https://www.sernapesca.cl""><img src=""../images/ico/sernapesca.svg"" height=""20"" /></a></td></tr>
<tr><td>PER Mitilidos</td>
<td align=""right""><a target=""_blank"" href=""https://www.mejillondechile.cl""><img src=""../images/ico/mejillondechile.min.png"" height=""20"" /></a></td></tr>
<tr><td>Subpesca</td>
<td align=""right""><a target=""_blank"" href=""https://www.subpesca.cl""><img src=""../images/ico/subpesca.png"" height=""20"" /></a></td></tr>`;infowindow.setContent(i+t+r);infowindow.open(map,this)},addListenerOnPolygon=function(n){$.isEmptyObject(n)?psmb.getValue(!0).includes(this.zIndex)?this.setOptions({fillColor:selected,strokeColor:selected}):this.setOptions({fillColor:undefined,strokeColor:undefined}):psmb.getValue(!0).includes(this.zIndex)?(this.setOptions({fillColor:undefined,strokeColor:undefined}),psmb.removeActiveItemsByValue(this.zIndex)):(this.setOptions({fillColor:selected,strokeColor:selected}),psmb.setChoiceByValue(this.zIndex))},processMapData=function(n){var i,f,r,t,u;return isresearch||(i=new google.maps.Polygon({paths:n.position,zIndex:n.id,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35}),i.setMap(map),i.addListener("click",addListenerOnPolygon),polygons[n.id]=i),f=getBounds(n.position).getCenter(),bnds.extend(f),r=new google.maps.Marker({position:f,title:`${n.name} ${n.id}`,zIndex:n.id}),tableInfo[n.id]={name:n.name,comuna:n.comuna,provincia:n.provincia,code:n.code,rut:n.rut,businessName:n.businessName},n.rut in companies||(companies[n.rut]=[]),companies[n.rut].push(n.id),n.comunaId in psmbs||(psmbs[n.comunaId]=[]),psmbs[n.comunaId].push(n.id),t=Math.floor(n.comunaId/100),t in psmbs||(psmbs[t]=[]),psmbs[t].push(n.id),u=Math.floor(t/10),u in psmbs||(psmbs[u]=[]),psmbs[u].push(n.id),r.addListener("click",showInfo),markers[n.id]=r,r},supportsPassiveOption=!1;try{opts=Object.defineProperty({},"passive",{get:function(){supportsPassiveOption=!0;return}});noop=function(){};window.addEventListener("testPassiveEventSupport",noop,opts);window.removeEventListener("testPassiveEventSupport",noop,opts)}catch(e){}passive=supportsPassiveOption?{passive:!0}:!1;filter=function(){var t=company.getValue(!1),i=psmb.getValue(!1),r=t.length>0,u=i.length>0,n;r||u?(markerCluster.clearMarkers(),Object.values(markers).forEach(n=>{n.setMap(null)}),n=[],r&&t.forEach(t=>{companies[t.value]&&companies[t.value].forEach(t=>{markers[t].setMap(map),n.push(markers[t])})}),u&&i.forEach(t=>{psmbs[t.value]&&psmbs[t.value].forEach(t=>{markers[t].setMap(map),n.push(markers[t])})}),console.log(n),markerCluster.addMarkers(n)):(Object.values(markers).forEach(n=>{n.setMap(map)}),markerCluster.addMarkers(Object.values(markers)))};epsmb.addEventListener("addItem",()=>filter(),passive);epsmb.addEventListener("removeItem",()=>filter(),passive);ecompany.addEventListener("addItem",()=>filter(),passive);ecompany.addEventListener("removeItem",()=>filter(),passive);var clickMap=function(n){n!==undefined&&polygons[n.detail.value]!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})},getList=function(n){return __awaiter(this,void 0,void 0,function*(){return yield fetch(`/api/static/json/${lang}/${n}list.json`).then(n=>n.json()).catch(t=>console.error(t,n))})},init=function(){return __awaiter(this,void 0,void 0,function*(){var n=isresearch?"research":"farm",t=isresearch?"institution":"company",i=fetch(`/api/static/json/${lang}/${n}data.json`).then(n=>n.json()).then(n=>n.map(processMapData)).then(n=>{map.fitBounds(bnds),markerCluster=new MarkerClusterer(map,n,{imagePath:"/images/markers/m"})}),r=getList("comuna"+n),u=getList("provincia"+n),f=getList("region"),e=getList(n),o=getList(t),s=Promise.all([r,u,f]).then(n=>(psmb.setChoices(n[0].concat(n[1]).concat([n[2]])),!0)),h=Promise.all([e,o]).then(n=>(company.setChoices(n[0].concat(n[1])),!0));Promise.all([s,h,i]).then(()=>{loaderStop()})})};init();