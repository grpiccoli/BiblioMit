var __awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},loaderStart=()=>{document.getElementById("preloader-background").style.display="block"},loaderStop=()=>{document.getElementById("preloader-background").style.display="none"},opts,noop,clickMap;loaderStart();var Area=function(n){return(google.maps.geometry.spherical.computeArea(n)/1e4).toFixed(2)},flatten=function(n){const t=[];return n.forEach(n=>{Array.isArray(n)?t.push(...flatten(n)):t.push(n)}),t},getBounds=function(n){var t=new google.maps.LatLngBounds;return flatten(n).forEach(n=>t.extend(n)),t},selected="red",lang=$("html").attr("lang"),esp=lang==="es",choiceOps={maxItemCount:50,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,fuseOptions:{include:"score"}};esp&&(choiceOps.searchPlaceholderValue="Buscar",choiceOps.loadingText="Cargando...",choiceOps.noResultsText="Sin resultados",choiceOps.noChoicesText="Sin opciones a elegir",choiceOps.itemSelectText="Presione para seleccionar",choiceOps.maxItemText=n=>`MÃ¡ximo ${n} valores`);var semaforo=!document.getElementById("semaforo").classList.contains("d-none"),epsmb=document.getElementById("psmb"),psmb=new Choices(epsmb,choiceOps),evariable=document.getElementById("variable"),variables=new Choices(evariable,choiceOps),etl=document.getElementById("tl"),tl=new Choices(etl,choiceOps),customvar=document.getElementById("variables"),customvars=new Choices(customvar,choiceOps),map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"terrain"}),infowindow=new google.maps.InfoWindow({maxWidth:500}),tableInfo=[],polygons={},stats={},circles={},bnds=new google.maps.LatLngBounds,markers=[],clusters,showInfo=function(){var n=this.zIndex;fetch(`/ambiental/getcontent?Name=${tableInfo[n].name}&Code=${tableInfo[n].code}&Commune=${tableInfo[n].comuna}&Province=${tableInfo[n].provincia}&Area=${Area(polygons[n].getPath().getArray())}`,{credentials:"same-origin"}).then(n=>n.text()).then(n=>{infowindow.setContent(n),infowindow.open(map,this)})},addListenerOnPolygon=function(n){$.isEmptyObject(n)?psmb.getValue(!0).includes(this.zIndex)?this.setOptions({fillColor:selected,strokeColor:selected}):this.setOptions({fillColor:undefined,strokeColor:undefined}):psmb.getValue(!0).includes(this.zIndex)?(this.setOptions({fillColor:undefined,strokeColor:undefined}),psmb.removeActiveItemsByValue(this.zIndex)):(this.setOptions({fillColor:selected,strokeColor:selected}),psmb.setChoiceByValue(this.zIndex))},processMapData=function(n){var t=new google.maps.Polygon({paths:n.position,zIndex:n.id}),i,r;return t.setMap(map),t.addListener("click",addListenerOnPolygon),polygons[n.id]=t,i=getBounds(n.position).getCenter(),n.id<4&&bnds.extend(i),r=new google.maps.Marker({position:i,title:`${n.name} ${n.id}`,zIndex:n.id}),tableInfo[n.id]={name:n.name,comuna:n.comuna,provincia:n.provincia,code:n.code},r.addListener("click",showInfo),r},chart=am4core.create("chartdiv",am4charts.XYChart),dateAxis=chart.xAxes.push(new am4charts.DateAxis);dateAxis.dataFields.category="date";var valueAxis=chart.yAxes.push(new am4charts.ValueAxis),chartloaded=!1,loadChart=function(){am4core.useTheme(am4themes_kelly);chart.language.locale=esp?am4lang_es_ES:am4lang_en_US;chart.scrollbarY=new am4core.Scrollbar;chart.scrollbarX=new am4core.Scrollbar;chart.zoomOutButton.align="left";chart.zoomOutButton.valign="bottom";dateAxis.dateFormats.setKey("year","yy");dateAxis.periodChangeDateFormats.setKey("month","MMM yy");dateAxis.tooltipDateFormat="dd MMM, yyyy";dateAxis.renderer.minGridDistance=40;chart.legend=new am4charts.Legend;var n=am4core.create("legenddiv",am4core.Container);n.width=am4core.percent(100);n.height=am4core.percent(100);chart.legend.parent=n;chart.cursor=new am4charts.XYCursor;chart.exporting.menu=new am4core.ExportMenu;semaforo||(chart.exporting.formatOptions.getKey("png").disabled=!0,chart.exporting.formatOptions.getKey("svg").disabled=!0,chart.exporting.formatOptions.getKey("pdf").disabled=!0,chart.exporting.formatOptions.getKey("json").disabled=!0,chart.exporting.formatOptions.getKey("csv").disabled=!0,chart.exporting.formatOptions.getKey("xlsx").disabled=!0,chart.exporting.formatOptions.getKey("html").disabled=!0,chart.exporting.formatOptions.getKey("pdfdata").disabled=!0);chartloaded=!0;chart.events.off("validated",loadChart)};chart.events.on("validated",loadChart);var loadDates=function(){for(var t=$("#start").val(),i=$("#end").val(),n=moment(t),r=moment(i);n<=r;)chart.data.push({date:n.format("yyyy-MM-DD")}),n.add(1,"days");return chart.data},fetchData=function(n,t,i){return __awaiter(this,void 0,void 0,function*(){if(!(t in chart.exporting.dataFields)){var u=t.split("_"),f=u.splice(1,1)[0],r=u.join("_");return chart.exporting.dataFields[t]=i,yield fetch(n).then(n=>n.json()).then(n=>{var u=0,e;chart.data.forEach(i=>{u<n.length&&i.date===n[u].date&&(i[t]=n[u].value,u++,u==n.length&&(stats[r]==null&&(stats[r]={}),stats[r][f]=n[u-1].value))});e=chart.series.push(new am4charts.LineSeries);e.dataFields.valueY=t;e.dataFields.dateX="date";e.name=i;e.tooltipText="{name}: [bold]{valueY}[/]";e.showOnInit=!1}).catch(()=>{delete chart.exporting.dataFields[t]})}})},generatefetchData=function(n,t,i,r){return __awaiter(this,void 0,void 0,function*(){var u=`${n.value}_${t.value}`,f=`${n.label} ${t.label}`,e=`/ambiental/data?area=${t.value}&type=${n.value.charAt(0)}&id=${n.value.substring(1)}&start=${i}&end=${r}`;return yield fetchData(e,u,f)})},green=[0,128,0],red=[255,0,0],circlemax=2e4,circlemin=5e3,loadData=function(n,t){return __awaiter(this,void 0,void 0,function*(){var i=t?variables.getValue().concat(customvars.getValue()):psmb.getValue();if(i.length!==0){loaderStart();var r=$("#start").val(),u=$("#end").val(),f=t?i.map(t=>generatefetchData(t,n.detail,r,u)):i.map(t=>generatefetchData(n.detail,t,r,u));return Promise.all(f).then(()=>{chart.invalidateData()})}})},redrawCircles=function(){var r,u,n,t,i,f;removeCircles();r=variables.getValue(!0).slice(-1)[0];u=psmb.getValue(!0);r!=undefined&&u.length&&Object.keys(stats).length&&(n=stats[r],f={},n!=undefined&&(u.forEach(r=>{t=t===undefined||n[r]<t?n[r]:t,i=i===undefined||n[r]>i?n[r]:i,f[r]=n[r]}),Object.entries(f).forEach(([n,r])=>{var e=markers.find(t=>t.zIndex==n),u=t==i?1:(r-t)/(i-t),f=pickHex(red,green,u),o=circlemin+(circlemax-circlemin)*u;circles[n]=new google.maps.Circle({strokeColor:"#"+f,strokeOpacity:.8,strokeWeight:.1,fillColor:"#"+f,fillOpacity:.35,map:map,center:e.position,radius:o});google.maps.event.addListener(circles[n],"mouseover",function(){this.getMap().getDiv().setAttribute("title",`${r}`)});google.maps.event.addListener(circles[n],"mouseout",function(){this.getMap().getDiv().removeAttribute("title")})})))},supportsPassiveOption=!1;try{opts=Object.defineProperty({},"passive",{get:function(){supportsPassiveOption=!0;return}});noop=function(){};window.addEventListener("testPassiveEventSupport",noop,opts);window.removeEventListener("testPassiveEventSupport",noop,opts)}catch(e){}var passive=supportsPassiveOption?{passive:!0}:!1,removeCircle=function(n){var t=circles[n];google.maps.event.clearListeners(t,"click_handler_name");google.maps.event.clearListeners(t,"drag_handler_name");google.maps.event.clearListeners(t,"mouseover");google.maps.event.clearListeners(t,"mouseout");t.setRadius(0);t.setMap(null);delete circles[n]},removeCircles=()=>{Object.keys(circles).forEach(n=>removeCircle(n))},removeSeries=function(n){chart.series.values.forEach((t,i)=>{t.dataFields.valueY===n&&(delete chart.exporting.dataFields[n],chart.series.removeIndex(i).dispose())})};customvar.addEventListener("addItem",n=>__awaiter(this,void 0,void 0,function*(){var t=psmb.getValue();if(t.length!==0){loaderStart();var i=$("#start").val(),r=$("#end").val(),u=t.map(t=>__awaiter(this,void 0,void 0,function*(){var u=`${n.detail.value}_${t.value}`,f=`${n.detail.label} ${t.label}`,e=`/ambiental/customdata?area=${t.value}&typeid=${n.detail.value}&start=${i}&end=${r}`;return yield fetchData(e,u,f)}));Promise.all(u).then(()=>{chart.invalidateData(),redrawCircles()})}}),passive);customvar.addEventListener("removeItem",n=>{psmb.getValue(!0).forEach(t=>{var i=`${n.detail.value}_${t}`;removeSeries(i)}),redrawCircles()},passive);evariable.addEventListener("addItem",n=>__awaiter(this,void 0,void 0,function*(){yield loadData(n,!1);redrawCircles()}),passive);evariable.addEventListener("removeItem",n=>{psmb.getValue(!0).forEach(t=>{var i=`${n.detail.value}_${t}`;removeSeries(i)}),redrawCircles()},passive);clickMap=function(n){n!==undefined&&polygons[n.detail.value]!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})};epsmb.addEventListener("addItem",n=>__awaiter(this,void 0,void 0,function*(){yield loadData(n,!0);clickMap(n);redrawCircles()}),passive);epsmb.addEventListener("removeItem",n=>{variables.getValue(!0).forEach(t=>{var i=`${t}_${n.detail.value}`;removeSeries(i)}),clickMap(n),redrawCircles()},passive);var getList=function(n){return __awaiter(this,void 0,void 0,function*(){return yield fetch(`/api/static/json/${lang}/${n}list.json`).then(n=>n.json()).catch(t=>console.error(t,n))})},loaderStopped=function(){return new Promise(n=>{(function t(){if(document.getElementById("preloader-background").style.display==="none")return n();setTimeout(t,400)})()})},chartLoaded=function(){return new Promise(n=>{(function t(){if(chartloaded)return n();setTimeout(t,400)})()})},init=function(){return __awaiter(this,void 0,void 0,function*(){var n,u,f;loadDates();var t=fetch(`/api/static/json/${lang}/cuencadata.json`).then(n=>n.json()).then(n=>n.map(processMapData)).then(n=>{markers=n,map.fitBounds(bnds),map.setCenter(bnds.getCenter())}),l=getList("oceanvar"),a=getList("cuenca"),e=fetch(`/api/static/json/${lang}/comunadata.json`).then(n=>n.json()).then(n=>n.map(processMapData)).then(n=>markers=markers.concat(n)),o=getList("comuna"),s=getList("groupvar"),v=getList("customvar"),i=Promise.all([l]).then(n=>(variables.setChoices([n[0]]),!0)),r=Promise.all([a]).then(n=>(psmb.setChoices([n[0]]),!0)),h=Promise.all([v]).then(n=>(customvars.setChoices([n[0]]),!0));let c=Promise.all([i,r,t]).then(()=>(variables.setChoiceByValue("v0"),psmb.setChoiceByValue(1),chartLoaded()));if(semaforo){var y=fetch(`/api/static/json/${lang}/psmbdata.json`).then(n=>n.json()).then(n=>n.map(processMapData)).then(n=>markers=markers.concat(n)),p=getList("psmb"),w=getList("genusvar"),b=getList("speciesvar"),k=getList("tl"),u=Promise.all([r,o,p]).then(n=>(psmb.setChoices(n[1].concat(n[2])),!0)),f=Promise.all([i,s,w,b]).then(n=>(variables.setChoices([n[1],n[2],n[3]]),!0)),d=Promise.all([k]).then(n=>(tl.setChoices(n[0]),!0));clusters=Promise.all([t,e,y]).then(()=>new MarkerClusterer(map,markers,{imagePath:"/images/markers/m"}));n=function(n,t,i,r,u,f,e){var o=e===0,s=o?r.map(r=>u.map(u=>{var f=[n.value,r.value,u.value].join("_"),e,o;if(!chart.series._values.some(n=>f===n.dataFields.valueY))return e=[n.label,r.label,u.label.replace("<i>","[bold font-style: italic]").replace("<\/i>","[/]")].join(" "),o=`/ambiental/tldata?a=${n.value}&psmb=${r.value}&sp=${u.value}&start=${t}&end=${i}`,fetchData(o,f,e)})):f.filter(n=>Math.floor(n.value/10)===e).map(f=>r.map(r=>u.map(u=>{var e=[n.value,r.value,u.value,f.value].join("_"),o,s;if(!chart.series._values.some(n=>e===n.dataFields.valueY))return o=[n.label,r.label,u.label.replace("<i>","[bold font-style: italic]").replace("<\/i>","[/]"),f.label].join(" "),s=`/ambiental/tldata?a=${n.value}&psmb=${r.value}&sp=${u.value}&v=${f.value}&start=${t}&end=${i}`,fetchData(s,e,o)})));return Promise.all(s).then(n=>n)};etl.addEventListener("addItem",()=>{var t=tl.getValue(),e=t.filter(n=>Math.floor(n.value/10)===1),i,r,u,f;e.length!==0&&(i=t.filter(n=>Math.floor(n.value/10)===2),r=t.filter(n=>Math.floor(n.value/10)===3),i.length!==0&&r.length!==0&&(loaderStart(),u=$("#start").val(),f=$("#end").val(),e.forEach(e=>{switch(e.value){case 14:case 17:return n(e,u,f,i,r,null,0);case 11:return n(e,u,f,i,r,t,4);case 12:return n(e,u,f,i,r,t,5);case 15:return n(e,u,f,i,r,t,6);case 13:case 16:return n(e,u,f,i,r,t,7);default:return}}),chart.invalidateData()))},passive);etl.addEventListener("removeItem",n=>{if(chart.series.values.length!==0){var i=chart.series.values.map(n=>n.dataFields.valueY),r=n.detail.value,t=0;i.forEach((n,i)=>{n.match(/^[1-7][0-8]_[1-7][0-8]_[1-7][0-8](_[1-7][0-8])?$/g)&&n.includes(r)&&(delete chart.exporting.dataFields[n],chart.series.removeIndex(i-t).dispose(),t++)})}},passive);Promise.all([c,u,f,d,clusters,h]).then(()=>{chart.events.on("validated",loaderStop);loaderStop()})}else u=Promise.all([r,o]).then(n=>(psmb.setChoices(n[1]),!0)),f=Promise.all([i,s]).then(n=>(variables.setChoices([n[1]]),!0)),clusters=Promise.all([t,e]).then(()=>new MarkerClusterer(map,markers,{imagePath:"/images/markers/m"})),Promise.all([c,u,f,clusters,h]).then(()=>{chart.events.on("validated",loaderStop);loaderStop()})})};init();$(".input-daterange").datepicker({inputs:Array.from($(".actual_range")),format:"yyyy-mm-dd",language:lang,startDate:$("#start").val().toString(),endDate:$("#end").val().toString()}).on("changeDate",()=>{var t=variables.getValue(!0),n;variables.removeActiveItems();semaforo&&(n=tl.getValue(!0),tl.removeActiveItems());chart.data=[];loadDates();t.forEach(n=>variables.setChoiceByValue(n));semaforo&&n.forEach(n=>tl.setChoiceByValue(n))});var CreateTableFromJSON=function(n){for(var e,r,f,o,u,s,h,i=[],t=0;t<n.length;t++)for(e in n[t])i.indexOf(e)===-1&&i.push(e);for(r=document.createElement("table"),r.className="table",r.id="newTable",f=r.insertRow(-1),t=0;t<i.length;t++)o=document.createElement("th"),o.innerHTML=i[t],f.appendChild(o);for(t=0;t<n.length;t++)for(f=r.insertRow(-1),u=0;u<i.length;u++)s=f.insertCell(-1),n[t][i[u]]&&(s.innerHTML=n[t][i[u]]);h=document.getElementById("results");h.appendChild(r)},fetchPlankton=function(){var n=$("#start").val(),t=$("#end").val(),i=psmb.getValue(!0).map(i=>fetch("/ambiental/BuscarInformes?"+`id=${i}&start=${n}&end=${t}`).then(n=>n.json()));Promise.all(i).then(n=>{var t=document.getElementById("results");t.innerHTML="";n.forEach(n=>CreateTableFromJSON(n))});$("#table2excel").show()},tableToExcel=function(){var n="data:application/vnd.ms-excel;base64,",t='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}<\/x:Name><x:WorksheetOptions><x:DisplayGridlines/><\/x:WorksheetOptions><\/x:ExcelWorksheet><\/x:ExcelWorksheets><\/x:ExcelWorkbook><\/xml><![endif]--><\/head><body><table>{table}<\/table><\/body><\/html>',i=function(n){return window.btoa(unescape(encodeURIComponent(n)))},r=function(n,t){return n.replace(/{(\w+)}/g,function(n,i){return t[i]})};return function(u,f){u.nodeType||(u=document.getElementById(u));var e={worksheet:f||"Worksheet",table:u.innerHTML};window.location.href=n+i(r(t,e))}}();$("#fetchPlankton").click(fetchPlankton);$("#table2excel").click(function(){tableToExcel("newTable","Ensayos")});document.getElementById("legenddiv").addEventListener("DOMSubtreeModified",function(){document.getElementById("legenddiv").style.height=chart.legend.contentHeight+"px"});document.getElementById("pin-switch").addEventListener("change",function(){return __awaiter(this,void 0,void 0,function*(){this.checked?(yield clusters).addMarkers(markers):((yield clusters).clearMarkers(),Object.values(markers).forEach(n=>{n.setMap(null)}))})});document.getElementById("polygon-switch").addEventListener("change",function(){return __awaiter(this,void 0,void 0,function*(){this.checked?Object.values(polygons).forEach(n=>{n.setMap(map)}):Object.values(polygons).forEach(n=>{n.setMap(null)})})});document.getElementById("stat-switch").addEventListener("change",function(){return __awaiter(this,void 0,void 0,function*(){this.checked?Object.values(circles).forEach(n=>{n.setMap(map)}):Object.values(circles).forEach(n=>{n.setMap(null)})})});